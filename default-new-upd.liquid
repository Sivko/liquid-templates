<%
  date = invoice.upd_date.present? ? invoice.upd_date : invoice.issued_at
  number = invoice.documents_number.present? ? invoice.documents_number : invoice.custom_number
  amount_to_pay = invoice.amount_to_pay(invoice.positions)
  positions = invoice.positions.ordered.eager_load(:product)
  colspan_20 = 20

  payment_order_date = invoice.payment_order_date.present? ? invoice.payment_order_date : invoice.issued_at
  shipping_date = invoice.shipping_date.present? ? invoice.shipping_date : invoice.issued_at
%>

<table class="unbreakable">
  <tr>
    <td colspan=8 rowspan=4 class="text-top border-right" style="width: 71px;">Универсальный передаточный документ</td>
    <td colspan=11 class="padding-left bigger">Счет-фактура №</td>
    <td colspan=7 class="centered border-bottom"><%= number %></td>
    <td colspan=2 class="centered bigger">от</td>
    <td colspan=10 class="centered border-bottom"><%= l(date, format: :as_date) %></td>
    <td colspan=4>(1)</td>
    <td colspan=<%= 45 + colspan_20 %> rowspan=3 class="text-top smaller text-right">
      Приложение № 1 к постановлению Правительства Российской Федерации от 26 декабря 2011 г. № 1137<br />
      (в редакции постановления Правительства Российской Федерации от 16 августа 2024 г. № 1096)
    </td>
  </tr>
  <tr>
    <td colspan=11 class="padding-left bigger">Исправление №</td>
    <td colspan=7 class="centered border-bottom">-</td>
    <td colspan=2 class="centered bigger">от</td>
    <td colspan=10 class="centered border-bottom">-</td>
    <td colspan=4>(1а)</td>
  </tr>
  <tr>
    <td colspan=32 style="height:6px"></td>
  </tr>
  <tr>
    <td colspan=16 class="padding-left"><strong>Продавец</strong></td>
    <td colspan=<%= 60 + colspan_20 %> class="border-bottom"><%= invoice.org_detail&.short_name %></td>
    <td colspan=3 class="centered">(2)</td>
  </tr>
  <tr>
    <td colspan=4>Статус:</td>
    <td colspan=2 class="bordered centered"><%= invoice.vat_kind == "without" ? 2 : 1 %></td>
    <td colspan=2 class="border-right">&nbsp;</td>
    <td colspan=16 class="padding-left">Адрес</td>
    <td colspan=<%= 60 + colspan_20 %> class="border-bottom"><%= only_address(invoice.org_detail) %></td>
    <td colspan=3 class="centered">(2а)</td>
  </tr>
  <tr>
    <td colspan=8 rowspan=10 class="text-top border-right smaller"><br>
      1 - счет-фактура и передаточный документ (акт) <br>
      2 - передаточный документ (акт)
    </td>
    <td colspan=16 class="padding-left">ИНН/КПП продавца</td>
    <td colspan=<%= 60 + colspan_20 %> class="border-bottom"><%= invoice.org_detail.decorate.inn_kpp_line if invoice.org_detail %></td>
    <td colspan=3 class="centered">(2б)</td>
  </tr>
  <tr>
    <td colspan=16 class="padding-left">Грузоотправитель и его адрес</td>
    <td colspan=<%= 60 + colspan_20 %> class="border-bottom">он же</td>
    <td colspan=3 class="centered">(3)</td>
  </tr>
  <tr>
    <td colspan=16 class="padding-left">Грузополучатель и его адрес</td>
    <td colspan=<%= 60 + colspan_20 %> class="border-bottom"><%= invoice_consignee_or_payer_info(invoice) %></td>
    <td colspan=3 class="centered">(4)</td>
  </tr>
  <tr>
    <td colspan=16 class="padding-left">К платежно-расчетному документу</td>
    <td colspan=2 class="centered">№</td>
    <td colspan=8 class="border-bottom"><%= invoice.payment_order_number %></td>
    <td colspan=2 class="centered">от</td>
    <td colspan=<%= 48 + colspan_20 %> class="border-bottom"><%= l(payment_order_date, format: :as_date, default: nil) %></td>
    <td colspan=3 class="centered">(5)</td>
  </tr>
  <tr>
    <td colspan=16 class="padding-left">Документ об отгрузке № п/п</td>
    <td colspan=18 class="border-bottom">Универсальный передаточный документ</td>
    <td colspan=2 class="centered">№</td>
    <td colspan=5 class="border-bottom"><%= number %></td>
    <td colspan=2 class="centered">от</td>
    <td colspan=<%= 33 + colspan_20 %> class="border-bottom"><%= l(shipping_date, format: :as_date, default: nil) %></td>
    <td colspan=3 class="centered">(5а)</td>
  </tr>
  <tr>
    <td colspan=16 class="padding-left"><strong>Покупатель</strong></td>
    <td colspan=<%= 60 + colspan_20 %> class="border-bottom">
      <%= invoice.payer.try(:short_name).present? ? invoice.payer.short_name : invoice.payer.to_s %>
    </td>
    <td colspan=3 class="centered">(6)</td>
  </tr>
  <tr>
    <td colspan=16 class="padding-left">Адрес</td>
    <td colspan=<%= 60 + colspan_20 %> class="border-bottom"><%= only_address(invoice.payer) %></td>
    <td colspan=3 class="centered">(6а)</td>
  </tr>
  <tr>
    <td colspan=16 class="padding-left">ИНН/КПП покупателя</td>
    <td colspan=<%= 60 + colspan_20 %> class="border-bottom"><%= invoice.payer.decorate.inn_kpp_line if invoice.payer.is_a?(Company) %></td>
    <td colspan=3 class="centered">(6б)</td>
  </tr>
  <tr>
    <td colspan=16 class="padding-left">Валюта: наименование, код</td>
    <td colspan=<%= 60 + colspan_20 %> class="border-bottom">Российский рубль, 643</td>
    <td colspan=3 class="centered">(7)</td>
  </tr>
  <tr>
    <td colspan=16 class="padding-left">
      Идентификатор государственного контракта, договора (соглашения) (при наличии)
    </td>
    <td colspan=<%= 60 + colspan_20 %> class="border-bottom">&nbsp;</td>
    <td colspan=3 class="centered">(8)</td>
  </tr>
  <tr style="height:6px">
    <td colspan=8 class="border-right"></td>
    <td colspan=<%= 79 + colspan_20 %>></td>
  </tr>
</table>
<table class="main-table">
  <thead>
  <tr>
    <td colspan=6 rowspan=2>Код товара/ работ, услуг</td>
    <td colspan=2 rowspan=2>№ п/п</td>
    <td colspan=12 rowspan=2>
      Наименование товара (описание выполненных работ, оказанных услуг), имущественного права
    </td>
    <td colspan=3 rowspan=2>Код вида товара</td>
    <td colspan=8>Единица измерения</td>
    <td colspan=4 rowspan=2 style="width:40px">Коли-<br> чество (объем)</td>
    <td colspan=5 rowspan=2 style="width:70px">
      Цена (тариф) за единицу измерения
    </td>
    <td colspan=7 rowspan=2>Стоимость товаров <br> (работ, услуг), имущественных прав без налога - всего</td>
    <td colspan=4 rowspan=2>В том числе сумма акциза</td>
    <td colspan=4 rowspan=2 style="width:40px">Нало-<br> говая ставка</td>
    <td colspan=6 rowspan=2>Сумма налога, предъяв-<br> ляемая покупателю</td>
    <td colspan=7 rowspan=2>Стоимость товаров <br>(работ, услуг), имущественных прав с налогом - всего</td>
    <td colspan=9>Страна происхождения товара</td>
    <td colspan=9 rowspan=2>Регистрационный номер декларации на товары или регистрационный номер партии товара, подлежащего прослеживаемости </td>
    <td colspan=9>Количественная единица измерения товара, используемая в целях осуществления прослеживаемости </td>
    <td colspan=8 rowspan=2>Количество товара, подлежащего прослеживаем- ости, в количе- ственной единице измерения товара, используемой в целях осуществления прослеживаемости </td>
    <td colspan=7 rowspan=2>Стоимость товара, подлежащего прослеживаем ости, без налога на добавленную стоимость, в рублях </td>
  </tr>
  <tr>
    <td colspan=2>Код</td>
    <td colspan=6>Условное обозначение (националь-<br> ное)</td>
    <td colspan=4>Цифро-<br> вой код</td>
    <td colspan=5>Краткое наименова-<br>ние</td>
    <td colspan=2>Код</td>
    <td colspan=7>Условное обозначение</td>
  </tr>
  <tr>
    <td colspan=6>А</td>
    <td colspan=2>1</td>
    <td colspan=12>1а</td>
    <td colspan=3>1б</td>
    <td colspan=2>2</td>
    <td colspan=6>2а</td>
    <td colspan=4>3</td>
    <td colspan=5>4</td>
    <td colspan=7>5</td>
    <td colspan=4>6</td>
    <td colspan=4>7</td>
    <td colspan=6>8</td>
    <td colspan=7>9</td>
    <td colspan=4>10</td>
    <td colspan=5>10а</td>
    <td colspan=9>11</td>
    <td colspan=2>12</td>
    <td colspan=7>12а</td>
    <td colspan=8>13</td>
    <td colspan=7>14</td>
  </tr>
  </thead>
  <tbody>

  <%
    positions.each_with_index do |position, i|
      result_amount = position.result_amount.to_f
      vat_sum = position.result_vat
      sum_without_vat = result_amount - vat_sum&.to_f
      price = sum_without_vat.to_f / position.quantity.to_f
      is_observable = position.rnpt_number.present?
  %>
    <tr>
      <td colspan=6 class="centered" style="word-wrap: break-word;"><%= position.code.present? ? position.code : '-' %></td>
      <td colspan=2 class="centered"><%= i + 1 %></td>
      <td colspan=12 style="overflow-wrap: anywhere"><%= position.name.presence || position.product&.name %></td>
      <td colspan=3 class="centered">-</td>
      <td colspan=2 class="centered"><%= position.unit.present? ? '796' : '-'  %></td>
      <td colspan=6 class="centered"><%= position.unit.present? ? position.unit : '-' %></td>
      <td colspan=4 class="centered"><%= number_with_precision(position.quantity, strip_insignificant_zeros: true) %></td>
      <td colspan=5 class="text-right"><%= amount_to_currency(price) %></td>
      <td colspan=7 class="text-right"><%= amount_to_currency(sum_without_vat) %></td>
      <td colspan=4 class="centered">-</td>
      <td colspan=4 class="centered"><%= number_to_human(position.vat_rate, precision: 2, strip_insignificant_zeros: true) %>%</td>
      <td colspan=6 class="text-right"><%= vat_sum > 0 ? amount_to_currency(vat_sum) : invoice.vat_rate_val %></td>
      <td colspan=7 class="text-right"><%= amount_to_currency(result_amount) %></td>
      <td colspan=4 class="centered"><%= position.product&.country_code.presence || '-' %></td>
      <td colspan=5 class="centered"><%= position.product&.country.presence || '-' %></td>
      <td colspan=9 class="centered"><%= is_observable ? position.rnpt_number || '-' : '-' %></td>
      <td colspan=2 class="centered"><%= is_observable ? position.product&.unit&.code || '-' : '-'  %></td>
      <td colspan=7 class="centered"><%= is_observable ? position.product&.unit&.name || '-' : '-' %></td>
      <td colspan=8 class="centered"><%= is_observable ? number_with_precision(position.quantity, strip_insignificant_zeros: true) : '-'%></td>
      <td colspan=7 class="centered"><%= is_observable ? amount_to_currency(position.amount * position.quantity) : '-' %></td>
    </tr>
  <% end %>
  <tr class="unbreakable-after">
    <td colspan=6>&nbsp;</td>
    <td colspan=2>&nbsp;</td>
    <td colspan=32><strong>Всего к оплате</strong></td>
    <td colspan=7 class="text-right"><%= amount_to_currency(invoice.amount_without_vat) %></td>
    <td colspan=8 class="centered">Х</td>
    <td colspan=6 class="text-right"><%= amount_to_currency(invoice.result_vat) %></td>
    <td colspan=7 class="text-right"><%= amount_to_currency(amount_to_pay) %></td>
    <td colspan=4>&nbsp;</td>
    <td colspan=5>&nbsp;</td>
    <td colspan=9>&nbsp;</td>
    <td colspan=2>&nbsp;</td>
    <td colspan=7>&nbsp;</td>
    <td colspan=8>&nbsp;</td>
    <td colspan=7>&nbsp;</td>
  </tr>
  </tbody>
</table>
<div class="unbreakable">
  <table class="unbreakable table-condensed">
    <tr>
      <td colspan=8 class="border-right" style="height:4px;width: 73px;"></td>
      <td colspan=<%= 79 + colspan_20 %>></td>
    </tr>
    <tr>
      <td colspan=8 class="border-right">Документ составлен на<span> </span></td>
      <td>&nbsp;</td>
      <td colspan=16>Руководитель организации <br> или иное уполномоченное лицо</td>
      <td colspan=6 class="centered">
        <% if invoice.org_detail&.signature_manager_url.present? && invoice.with_stamp && invoice.org_detail.kpp.present? %>
          <%= image_tag invoice.org_detail&.signature_manager_url.gsub('https', 'http')  %>
        <% end %>
      </td>
      <td></td>
      <td colspan=15 class="centered">
        <%= initialize_name(invoice.org_detail&.manager_name) if invoice.org_detail && invoice.org_detail.kpp.present? %>
      </td>
      <td colspan=16 class="collapsed">Главный бухгалтер <br> или иное уполномоченное лицо</td>
      <td colspan=6 class="centered">
        <% if invoice.org_detail&.signature_accountant_url.present? && invoice.with_stamp && invoice.org_detail.kpp.present? %>
          <%= image_tag invoice.org_detail&.signature_accountant_url.gsub('https', 'http') %>
        <% end %>
      </td>
      <td></td>
      <td colspan=15 class="centered">
        <%= initialize_name(invoice.org_detail&.accountant) if invoice.org_detail && invoice.org_detail.kpp.present? %>
      </td>
    </tr>
    <tr>
      <td colspan=3 class="border-bottom centered page-count"></td>
      <td colspan=5 class="border-right">листах</td>
      <td>&nbsp;</td>
      <td colspan=16></td>
      <td colspan=6 class="hint">(подпись)</td>
      <td></td>
      <td colspan=15 class="hint">(ф.и.о.)</td>
      <td colspan=16></td>
      <td colspan=6 class="hint">(подпись)</td>
      <td></td>
      <td colspan=15 class="hint">(ф.и.о.)</td>
    </tr>
    <tr>
      <td colspan=8 class="border-right"></td>
      <td>&nbsp;</td>
      <td colspan=16>Индивидуальный предприниматель</td>
      <td colspan=6>
        <% if invoice.org_detail&.signature_manager_url.present? && invoice.with_stamp && invoice.org_detail.kpp.blank? %>
          <%= image_tag invoice.org_detail&.signature_manager_url.gsub('https', 'http')  %>
        <% end %>
      </td>
      <td></td>
      <td colspan=15 class="centered">
        <%= initialize_name(invoice.org_detail&.manager_name) if invoice.org_detail && invoice.org_detail.kpp.blank? %>
      </td>
      <td colspan=3></td>
      <td colspan=35 class="centered">
        <%= invoice.org_detail&.certificate if invoice.org_detail && invoice.org_detail.kpp.blank? %>
      </td>
    </tr>
    <tr>
      <td colspan=8 class="border-right"></td>
      <td>&nbsp;</td>
      <td colspan=16>или иное уполномоченное лицо</td>
      <td colspan=6 class="hint">(подпись)</td>
      <td>&nbsp;</td>
      <td colspan=15 class="hint">(ф.и.о.)</td>
      <td colspan=3>&nbsp;</td>
      <td colspan=35 class="hint">(реквизиты свидетельства о государственной регистрации индивидуального предпринимателя)</td>
    </tr>
    <tr>
      <td colspan=8 style="height: 2px"></td>
      <td colspan=77 class="border-top"></td>
    </tr>
  </table>
  <table class="unbreakable table-condensed">
    <tr>
      <td colspan=22 style="height:20px">Основание передачи (сдачи) / получения (приемки)</td>
      <td colspan=60><%= invoice.reason %></td>
      <td colspan=3>[8]</td>
    </tr>
    <tr>
      <td colspan=22></td>
      <td colspan=60 class="hint">(договор; доверенность и др.)</td>
      <td colspan=3></td>
    </tr>
    <tr>
      <td colspan=16>Данные о транспортировке и грузе</td>
      <td colspan=66>&nbsp;</td>
      <td colspan=3>[9]</td>
    </tr>
    <tr>
      <td colspan=16></td>
      <td colspan=66 class="hint">(транспортная
        накладная, поручение экспедитору, экспедиторская / складская расписка и др. /
        масса нетто/ брутто груза, если не приведены ссылки на транспортные
        документы, содержащие эти сведения)</td>
      <td colspan=3></td>
    </tr>
  </table>
  <table class="unbreakable">
    <tr>
      <td colspan=42 class="border-right" style="height:20px">Товар (груз) передал / услуги, результаты работ, права сдал</td>
      <td>&nbsp;</td>
      <td colspan=42>Товар (груз) получил / услуги, результаты работ, права принял</td>
    </tr>
    <tr>
      <td colspan=13 class="centered"><%= invoice.org_detail&.manager_position %></td>
      <td></td>
      <td colspan=10 class="centered collapsed">
        <% if invoice.org_detail&.signature_manager_url.present? && invoice.with_stamp %>
          <%= image_tag invoice.org_detail&.signature_manager_url.gsub('https', 'http')  %>
        <% end %>
      </td>
      <td></td>
      <td colspan=14 class="centered">
        <%= initialize_name(invoice.org_detail&.manager_name) if invoice.org_detail %>
      </td>
      <td colspan=3 class="border-right">[10]</td>
      <td>&nbsp;</td>
      <td colspan=13>&nbsp;</td>
      <td></td>
      <td colspan=10>&nbsp;</td>
      <td></td>
      <td colspan=14>&nbsp;</td>
      <td colspan=3>[15]</td>
    </tr>
    <tr>
      <td colspan=13 class="hint">(должность)</td>
      <td></td>
      <td colspan=10 class="hint">(подпись)</td>
      <td></td>
      <td colspan=14 class="hint">(ф.и.о.)</td>
      <td colspan=3 class="border-right"></td>
      <td>&nbsp;</td>
      <td colspan=13 class="hint">(должность)</td>
      <td></td>
      <td colspan=10 class="hint">(подпись)</td>
      <td></td>
      <td colspan=14 class="hint">(ф.и.о.)</td>
      <td colspan=3></td>
    </tr>
    <tr>
      <td colspan=15>Дата отгрузки, передачи (сдачи)</td>
      <td>&quot;</td>
      <td colspan=2 class="border-bottom centered"><%= l(shipping_date, format: '%d', default: nil) %></td>
      <td>&quot;</td>
      <td colspan=6 class="border-bottom centered"><%= l(shipping_date, format: '%B', default: nil) %></td>
      <td colspan=2 class="text-right">20</td>
      <td colspan=2 class="border-bottom"><%= l(shipping_date, format: '%y', default: nil) %></td>
      <td colspan=10>г.</td>
      <td colspan=3 class="border-right">[11]</td>
      <td>&nbsp;</td>
      <td colspan=13>Дата получения (приемки)</td>
      <td>&quot;</td>
      <td colspan=2 class="border-bottom">&nbsp;</td>
      <td>&quot;</td>
      <td colspan=6 class="border-bottom">&nbsp;</td>
      <td colspan=2 class="text-right">20</td>
      <td colspan=2 class="border-bottom">&nbsp;</td>
      <td colspan=12>г.</td>
      <td colspan=3>[16]</td>
    </tr>
    <tr>
      <td colspan=39>Иные сведения об отгрузке, передаче</td>
      <td colspan=3 class="border-right"></td>
      <td>&nbsp;</td>
      <td colspan=39>Иные сведения о получении, приемке</td>
      <td colspan=3></td>
    </tr>
    <tr>
      <td colspan=39>&nbsp;</td>
      <td colspan=3 class="border-right">[12]</td>
      <td>&nbsp;</td>
      <td colspan=39>&nbsp;</td>
      <td colspan=3>[17]</td>
    </tr>
    <tr>
      <td colspan=39 class="hint">(ссылки на неотъемлемые приложения, сопутствующие документы, иные документы и т.п.)</td>
      <td colspan=3 class="border-right"></td>
      <td>&nbsp;</td>
      <td colspan=39 class="hint">(информация о наличии/отсутствии претензии; ссылки
        на неотъемлемые приложения, и другие документы и т.п.)</td>
      <td colspan=3></td>
    </tr>
    <tr>
      <td colspan=39>Ответственный за правильность оформления факта хозяйственной жизни</td>
      <td colspan=3 class="border-right"></td>
      <td>&nbsp;</td>
      <td colspan=39>Ответственный за правильность оформления факта хозяйственной жизни</td>
      <td colspan=3></td>
    </tr>
    <tr>
      <td colspan=13 class="centered"><%= invoice.org_detail&.manager_position %></td>
      <td></td>
      <td colspan=10 class="centered collapsed">
        <% if invoice.org_detail&.signature_manager_url.present? && invoice.with_stamp %>
          <%= image_tag invoice.org_detail&.signature_manager_url.gsub('https', 'http')  %>
        <% end %>
      </td>
      <td></td>
      <td colspan=14 class="centered">
        <%= initialize_name(invoice.org_detail&.manager_name) if invoice.org_detail %>
      </td>
      <td colspan=3 class="border-right">[13]</td>
      <td>&nbsp;</td>
      <td colspan=13>&nbsp;</td>
      <td></td>
      <td colspan=10>&nbsp;</td>
      <td></td>
      <td colspan=14>&nbsp;</td>
      <td colspan=3>[18]</td>
    </tr>
    <tr>
      <td colspan=13 class="hint">(должность)</td>
      <td></td>
      <td colspan=10 class="hint">(подпись)</td>
      <td></td>
      <td colspan=14 class="hint">(ф.и.о.)</td>
      <td colspan=3 class="border-right"></td>
      <td>&nbsp;</td>
      <td colspan=13 class="hint">(должность)</td>
      <td></td>
      <td colspan=10 class="hint">(подпись)</td>
      <td></td>
      <td colspan=14 class="hint">(ф.и.о.)</td>
      <td colspan=3></td>
    </tr>
    <tr>
      <td colspan=42 class="border-right">Наименование
        экономического субъекта – составителя документа (в т.ч. комиссионера /
        агента)</td>
      <td>&nbsp;</td>
      <td colspan=39>Наименование экономического субъекта - составителя
        документа</td>
      <td colspan=3></td>
    </tr>
    <tr>
      <td colspan=39 class="centered">
        <% if invoice.org_detail && invoice.org_detail&.kpp.blank? %>
          <%= invoice.org_detail.short_name %>
          ИНН <%= invoice.org_detail.decorate.inn_kpp_line %>
        <% end %>
      </td>
      <td colspan=3 class="border-right">[14]</td>
      <td>&nbsp;</td>
      <td colspan=39></td>
      <td colspan=3>[19]</td>
    </tr>
    <tr>
      <td colspan=39 class="hint">(может не
        заполняться при проставлении печати в М.П., может быть указан ИНН / КПП)</td>
      <td colspan=3 class="border-right"></td>
      <td>&nbsp;</td>
      <td colspan=39 class="hint">(может не заполняться при проставлении печати в
        М.П., может быть указан ИНН / КПП)</td>
      <td colspan=3></td>
    </tr>
    <tr>
      <td colspan=13 class="text-right">М.П.
        <% if invoice.org_detail&.stamp_url.present? && invoice.with_stamp %>
          <%= image_tag invoice.org_detail&.stamp_url.gsub('https', 'http'), class: 'stamp' %>
        <% end %>
      </td>
      <td colspan=26></td>
      <td colspan=3 class="border-right"></td>
      <td>&nbsp;</td>
      <td colspan=13 class="text-right">М.П.</td>
      <td colspan=26></td>
      <td colspan=3></td>
    </tr>
  </table>
</div>
